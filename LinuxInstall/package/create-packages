#!/bin/bash
# Exit on error
set -e

GIT_ROOT="$(git rev-parse --show-toplevel)"

# Build Deb package

pushd Debian

rm -rf ./OpenTAP
mkdir -p OpenTAP/DEBIAN
mkdir -p OpenTAP/usr/bin
mkdir -p OpenTAP/usr/share/tap
mkdir -p OpenTAP/usr/share/doc/tap
mkdir -p OpenTAP/var/log/SessionLogs

cp "$GIT_ROOT/LICENSE.txt" OpenTAP/usr/share/doc/tap/copyright

echo "Extracting OpenTAP"
unzip -q ../OpenTAP.TapPackage -d OpenTAP/usr/share/tap

pushd OpenTAP/usr/share/tap
chmod +x tap
ln -s ../../../var/log/SessionLogs
popd
pushd OpenTAP/usr/bin 
ln -s ../share/tap/tap
popd

BYTES=$(du -sb OpenTAP | cut -f1)
DIVISOR=1024

# Size in KB, rounded up -- addition and subtraction is necessary because we're using integer division
SIZE_KB=$(((BYTES - 1) / DIVISOR + 1)) 

# sed control-debian -e "s/@VERSION@/$VERSION/g" -e "s/@SIZE_KB@/$SIZE_KB/g" > OpenTAP/DEBIAN/control
sed control-debian -e "s/@SIZE_KB@/$SIZE_KB/g" > OpenTAP/DEBIAN/control

./OpenTAP/usr/bin/tap sdk gitversion --replace OpenTAP/DEBIAN/control
# Don't package log file generated from gitversion
rm -rf ./OpenTAP/var/log/SessionLogs/*

chmod 775 OpenTAP/DEBIAN

echo "Building .deb package"
dpkg --build OpenTAP

mv OpenTAP.deb ..

echo "Built .deb package"

popd 

echo "Building .rpm package"

pushd RPM

rm -rf ./OpenTAP

cp -r ../Debian/OpenTAP .
cp OpenTAP.spec.in OpenTAP.spec
rm -rf ./OpenTAP/DEBIAN


VERSION_AND_RELEASE="$(./OpenTAP/usr/bin/tap sdk gitversion)"
VERSION="${VERSION_AND_RELEASE%%-*}"
RELEASE="${VERSION_AND_RELEASE#*-}"

rm -rf ./OpenTAP/var/log/SessionLogs/*

# RPM does not support dashes in version names
RELEASE="$(echo $RELEASE | sed "s/-/_/g")"

sed -i "s/@VERSION@/$VERSION/g" OpenTAP.spec 
sed -i "s/@RELEASE@/$RELEASE/g" OpenTAP.spec
sed -i "s;@BUILD_ROOT@;$(pwd);g" OpenTAP.spec


# Need to populate the rpm spec file with an index of all files in the package
pushd OpenTAP
# Enumerate regular files
find . -type f -printf '"%h/%f"\n' | sed -e "s;\./;/;g" >> ../OpenTAP.spec
# Enumerate symbolic links
find . -type l -printf '"%h/%f"\n' | sed -e "s;\./;/;g" >> ../OpenTAP.spec
cp ../OpenTAP.spec ../FixedOpenTAPSpec

rpmbuild --target=x86_64 --buildroot "$(pwd)" -bb ../OpenTAP.spec > ../opentap-rpm-build.log

popd

echo "Built .rpm package"