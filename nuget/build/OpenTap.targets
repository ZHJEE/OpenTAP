<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <OpenTapAutogeneratedMsBuildReferenceFile>$(MSBuildProjectDirectory)/obj/$(MSBuildProjectName).opentap.g.props</OpenTapAutogeneratedMsBuildReferenceFile>
  </PropertyGroup>

  <ImportGroup Condition="'$(ExcludeRestorePackageImports)' != 'true'">
    <Import Project="$(OpenTapAutogeneratedMsBuildReferenceFile)" Condition="Exists('$(OpenTapAutogeneratedMsBuildReferenceFile)')" />
  </ImportGroup>

  <ItemGroup Condition="'$(MSBuildThisFileDirectory)' != '' And HasTrailingSlash('$(MSBuildThisFileDirectory)') And '$(OS)' == 'Unix'">
    <PackagePayloadFiles Include="$(MSBuildThisFileDirectory)payload\**\*" Exclude="$(MSBuildThisFileDirectory)payload\tap.exe;$(MSBuildThisFileDirectory)payload\Dependencies\*\git2-*.dll"/>
  </ItemGroup>

  <ItemGroup Condition="'$(MSBuildThisFileDirectory)' != '' And HasTrailingSlash('$(MSBuildThisFileDirectory)') And '$(OS)' != 'Unix'">
    <PackagePayloadFiles Include="$(MSBuildThisFileDirectory)payload\**\*" Exclude="$(MSBuildThisFileDirectory)payload\tap;$(MSBuildThisFileDirectory)payload\tap.dll;$(MSBuildThisFileDirectory)payload\tap.runtimeconfig.json;$(MSBuildThisFileDirectory)payload\Dependencies\*\libgit2-*.so"/>
  </ItemGroup>

  <Target Name="CopyOpenTapPayloadFiles"
          Condition="'$(CopyOpenTapPayloadFiles)' != 'false' And
                     '$(OutDir)' != '' And
                     HasTrailingSlash('$(OutDir)') And
                     Exists('$(OutDir)')"
          Inputs="@(PackagePayloadFiles)"
          Outputs="@(PackagePayloadFiles -> '$(OutDir)%(RecursiveDir)%(Filename)%(Extension)')"
          BeforeTargets="Build;PostBuildEvent">
    <Copy SourceFiles="@(PackagePayloadFiles)"
          DestinationFiles="@(PackagePayloadFiles -> '$(OutDir)%(RecursiveDir)%(Filename)%(Extension)')" />
  </Target>

  <Target Name="CleanOpenTapPayloadFiles"
          Condition="'$(CleanOpenTapPayloadFiles)' != 'false' And
                     '$(OutDir)' != '' And
                     HasTrailingSlash('$(OutDir)') And
                     Exists('$(OutDir)')"
          BeforeTargets="Clean">
    <ItemGroup>
      <PackagePayloadFilesToClean Include="@(PackagePayloadFiles -> '$(OutDir)%(RecursiveDir)%(Filename)%(Extension)')"/>
    </ItemGroup>
    <Delete Files="@(PackagePayloadFilesToClean)" />
  </Target>

  <Target Name="CreateOpenTapPackage"
          Condition="'$(CreateOpenTapPackage)' != 'false' And
                     '$(OutDir)' != '' And
                     Exists('$(OutDir)') And
                     '$(OpenTapPackageDefinitionPath)' != '' And
                     Exists('$(OpenTapPackageDefinitionPath)')"
          AfterTargets="Build">
    <Exec Command=".\tap package create &quot;$(ProjectDir)\$(OpenTapPackageDefinitionPath)&quot;"
          Condition="'$(InstallCreatedOpenTapPackage)' != 'true'"
          WorkingDirectory="$(OutDir)" LogStandardErrorAsError="true" />
    <Exec Command=".\tap package create &quot;$(ProjectDir)\$(OpenTapPackageDefinitionPath)&quot; --install"
          Condition="'$(InstallCreatedOpenTapPackage)' == 'true'"
          WorkingDirectory="$(OutDir)" LogStandardErrorAsError="true" />
  </Target>

  <Target Name="ProcessOpenTapPackageList">
    <ItemGroup>
      <OpenTapPackagesToInstall Include="@(AdditionalOpenTapPackage)">
        <Version>%(AdditionalOpenTapPackage.Version)</Version>
        <Repository>%(AdditionalOpenTapPackage.Repository)</Repository>
      </OpenTapPackagesToInstall>
      <OpenTapPackagesToInstall Include="@(OpenTapPackageReference)">
        <Version>%(OpenTapPackageReference.Version)</Version>
        <Repository>%(OpenTapPackageReference.Repository)</Repository>
      </OpenTapPackagesToInstall>
    </ItemGroup>
  </Target>
  
  <Target Name="InstallOpenTapPackages"
        Inputs="$(MSBuildProjectFullPath)"
        Outputs="@(OpenTapPackagesToInstall-> '$(OutDir)Packages/%(Identity)/package.xml')"
        DependsOnTargets="CopyOpenTapPayloadFiles;ProcessOpenTapPackageList"
        BeforeTargets="Build" AfterTargets="CopyOpenTapPayloadFiles">
    <Exec Command=".\tap package install --dependencies --force &quot;%(Identity)&quot;"
          Condition="'%(OpenTapPackagesToInstall.Repository)' == '' AND '%(OpenTapPackagesToInstall.Version)' == ''"
          LogStandardErrorAsError="true" EnvironmentVariables="OPENTAP_DEBUG_INSTALL=true" WorkingDirectory="$(OutDir)"/>
    <Exec Command=".\tap package install --dependencies --force &quot;%(Identity)&quot; -r &quot;%(OpenTapPackagesToInstall.Repository)&quot;"
          Condition="'%(OpenTapPackagesToInstall.Repository)' != '' AND '%(OpenTapPackagesToInstall.Version)' == ''"
          LogStandardErrorAsError="true" EnvironmentVariables="OPENTAP_DEBUG_INSTALL=true" WorkingDirectory="$(OutDir)"/>
    <Exec Command=".\tap package install --dependencies --force &quot;%(Identity)&quot; --version &quot;%(OpenTapPackagesToInstall.Version)&quot;"
          Condition="'%(OpenTapPackagesToInstall.Repository)' == '' AND '%(OpenTapPackagesToInstall.Version)' != ''"
          LogStandardErrorAsError="true" EnvironmentVariables="OPENTAP_DEBUG_INSTALL=true" WorkingDirectory="$(OutDir)"/>
    <Exec Command=".\tap package install --dependencies --force &quot;%(Identity)&quot; -r &quot;%(OpenTapPackagesToInstall.Repository)&quot; --version &quot;%(OpenTapPackagesToInstall.Version)&quot;"
          Condition="'%(OpenTapPackagesToInstall.Repository)' != '' AND '%(OpenTapPackagesToInstall.Version)' != ''"
          LogStandardErrorAsError="true" EnvironmentVariables="OPENTAP_DEBUG_INSTALL=true" WorkingDirectory="$(OutDir)"/>
  </Target>

  <UsingTask TaskName="Keysight.OpenTap.Sdk.MSBuild.AddAssemblyReferencesFromPackage" AssemblyFile="$(MSBuildThisFileDirectory)\Keysight.OpenTap.Sdk.MSBuild.dll"/>
  <Target Name="GenerateOpenTapReferenceProps"
          Inputs="$(MSBuildProjectFullPath)"
          Outputs="$(OpenTapAutogeneratedMsBuildReferenceFile)"
      DependsOnTargets="InstallOpenTapPackages" BeforeTargets="ResolveReferences;CoreCompile">
    <ItemGroup>
      <OpenTapPackagesToReference Include="@(AdditionalOpenTapPackage->WithMetadataValue('Reference', 'true'))"/>
      <OpenTapPackagesToReference Include="@(OpenTapPackageReference)" Exclude="@(OpenTapPackageReference->WithMetadataValue('Reference', 'false'))"/>
    </ItemGroup>
    <AddAssemblyReferencesFromPackage PackageInstallDir="$(OutDir)"
                                      TargetMsBuildFile="$(OpenTapAutogeneratedMsBuildReferenceFile)"
                                      PackageNames="@(OpenTapPackagesToReference)">
      <Output TaskParameter="Assemblies" ItemName="_OpenTapPackagesReferences"/>
    </AddAssemblyReferencesFromPackage>
    <Touch Files="$(MSBuildThisFileFullPath)"/>
    <ItemGroup>
      <ReferencePathWithRefAssemblies Include="@(_OpenTapPackagesReferences-> '$(OutDir)%(Identity)')"/>
    </ItemGroup>
  </Target>

</Project>
